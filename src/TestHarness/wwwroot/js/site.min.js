!function(n){"use strict";var i=n.module("service.FileUpload",[]),t,r;i.factory("fileUploadService",["$http","$q",function(n,t){var r=1048576,i=0,e=0,o=0,s="",u={},f=0,l=new FileReader,h={},a=function(n){return btoa(String("000000"+n).slice(-6))},c=function(){var i=t.defer();return n.get("/home/getbyid/"+u.name+"/").then(function(n){(n.status===200||n.status===201)&&(console.log("SAS Token refreshed."),s=n.data,i.resolve(s))}),i.promise},v=function(){for(var r,f=s+"&comp=blocklist",t='<?xml version="1.0" encoding="utf-8"?><BlockList>',i=0;i<o;i++)t+="<Latest>"+a(i)+"<\/Latest>";t+="<\/BlockList>";r={method:"PUT",url:f,data:t,ignoreAuthModule:!0,headers:{"x-ms-blob-content-type":u.type},transformRequest:[]};n(r).then(function(n){console.log(n);h.resolve(n)},function(n){console.log(n);setTimeout(function(){c().then(function(){v()})},5e3)})},y=function(){if(i>0){var n=u.slice(e,e+r);l.readAsArrayBuffer(n);f=0;e+=r;i<r&&(r=i)}else v()},p=function(t){var r=s+"&comp=block&blockid="+a(o),u={method:"PUT",url:r,data:t,ignoreAuthModule:!0,headers:{"x-ms-blob-type":"BlockBlob"},transformRequest:[]};n(u).then(function(){o++;i-=t.length;y()},function(n){f++;f<6?(console.log("Warning, upload error, retrying the "+f+". time"),setTimeout(function(){c().then(function(){p(t)})},Math.pow(3,f-1)*5e3)):(console.log("Failure to upload file."),h.reject(n))})};return l.onloadend=function(n){if(n.target.readyState===FileReader.DONE){var t=new Uint8Array(n.target.result);p(t)}},{uploadFileInChunks:function(n){return u=n,o=0,e=0,i=n.size,h=t.defer(),i<r&&(r=i),c().then(function(){y()}),h.promise},bytesRemaining:function(){return i},percentUploaded:function(){return 100-i/u.size*100}}}]);t=n.module("controller.FileUpload",[]);t.controller("fileUploadController",["$rootScope","$scope","$http","fileUploadService",function(n,t,i,r){t.queue={};t.options={};t.percentUploaded=0;t.uploadFileInBlocks=function(){var n=document.getElementById("file").files[0];r.uploadFileInChunks(n).then(function(){t.queue={};t.percentUploaded=0})};t.$watch(r.percentUploaded,function(n){t.percentUploaded=n})}]);r=n.module("app",["service.FileUpload","controller.FileUpload"])}(angular);